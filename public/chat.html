<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PixelCanvas - Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="chat.js"></script>

  <!-- TailwindCSS for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>

  <!-- Socket.IO client -->
  <script src="/socket.io/socket.io.js"></script>

  <style>
    body { background: #0f172a; color: #f1f5f9; }
    #chatBox { max-height: 70vh; overflow-y: auto; }
    .msg-bubble { padding: 8px 12px; border-radius: 12px; display: inline-block; }
    .msg-self { background: #3b82f6; color: white; align-self: flex-end; }
    .msg-other { background: #334155; color: #f1f5f9; align-self: flex-start; }
  </style>
</head>
<body class="flex flex-col h-screen">

  <!-- Header -->
  <header class="bg-gray-900 p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">PixelCanvas Chat</h1>
    <div id="userStatus" class="flex items-center gap-2">
      <button id="btnSignIn" class="px-3 py-1 bg-blue-600 rounded hover:bg-blue-500">Sign In</button>
      <button id="btnSignOut" class="px-3 py-1 bg-red-600 rounded hover:bg-red-500 hidden">Sign Out</button>
    </div>
  </header>

  <!-- Chat Area -->
  <main class="flex-1 flex flex-col p-4">
    <div id="chatBox" class="flex flex-col gap-2 mb-4 bg-gray-800 p-3 rounded-xl shadow-inner"></div>
    <div class="flex gap-2">
      <input id="chatInput" type="text" placeholder="Type your message..."
             class="flex-1 px-3 py-2 rounded-xl bg-gray-700 text-white outline-none"
             disabled>
      <button id="btnSend"
              class="px-4 py-2 bg-green-600 rounded-xl hover:bg-green-500 disabled:opacity-50"
              disabled>Send</button>
    </div>
  </main>

  <!-- Scripts -->
  <script src="firebase-config.js"></script>
  <script>
    // Firebase init
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Socket.IO
    const socket = io();

    // Elements
    const chatBox = document.getElementById('chatBox');
    const chatInput = document.getElementById('chatInput');
    const btnSend = document.getElementById('btnSend');
    const btnSignIn = document.getElementById('btnSignIn');
    const btnSignOut = document.getElementById('btnSignOut');

    let currentUser = null;

    // Append message to chat
    function appendMessage(msg) {
      const div = document.createElement('div');
      div.className = 'flex ' + (msg.uid === (currentUser?.uid || '') ? 'justify-end' : 'justify-start');
      const bubble = document.createElement('div');
      bubble.className = 'msg-bubble ' + (msg.uid === (currentUser?.uid || '') ? 'msg-self' : 'msg-other');
      bubble.textContent = msg.displayName + ': ' + msg.text;
      div.appendChild(bubble);
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Handle socket messages
    socket.on('chatMessage', (msg) => {
      appendMessage(msg);
    });

    // Send chat
    btnSend.addEventListener('click', async () => {
      if (!chatInput.value.trim()) return;
      const idToken = await currentUser.getIdToken();
      fetch('/api/chat/send', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'authorization': 'Bearer ' + idToken
        },
        body: JSON.stringify({ text: chatInput.value })
      })
      .then(r => r.json())
      .then(res => {
        if (!res.success) alert(res.error || 'Message failed');
      })
      .catch(err => console.error(err));

      chatInput.value = '';
    });

    // Firebase Auth
    btnSignIn.addEventListener('click', async () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        await auth.signInWithPopup(provider);
      } catch (err) {
        console.error(err);
        alert('Sign-in failed: ' + err.message);
      }
    });

    btnSignOut.addEventListener('click', () => {
      auth.signOut();
    });

    auth.onAuthStateChanged(user => {
      currentUser = user;
      if (user) {
        btnSignIn.classList.add('hidden');
        btnSignOut.classList.remove('hidden');
        chatInput.disabled = false;
        btnSend.disabled = false;

        // Load last 50 messages from server
        user.getIdToken().then(token => {
          fetch('/api/chat/history', {
            headers: { 'authorization': 'Bearer ' + token }
          })
          .then(r => r.json())
          .then(data => {
            chatBox.innerHTML = '';
            data.messages.forEach(m => appendMessage(m));
          });
        });
      } else {
        btnSignIn.classList.remove('hidden');
        btnSignOut.classList.add('hidden');
        chatInput.disabled = true;
        btnSend.disabled = true;
        chatBox.innerHTML = '<p class="text-gray-400 text-center">Sign in to join the chat</p>';
      }
    });

    // Send message on Enter key
    chatInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') btnSend.click();
    });
  </script>

  <script src="/firebase-config.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
  <script>
    const app = firebase.initializeApp(window.firebaseConfig);
  </script>
  
</body>
</html>
